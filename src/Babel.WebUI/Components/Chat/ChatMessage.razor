@if (Message != null)
{
    <div class="@GetMessageContainerClass() mb-3">
        <MudPaper Elevation="1" Class="@($"{GetMessageClass()} pa-3")" Style="@GetMessageStyle()">
            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@Message.Content</MudText>

            @if (!Message.IsUser && Message.References.Count > 0)
            {
                <div class="mt-2 pt-2" style="border-top: 1px solid var(--mud-palette-divider);">
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-1">
                        <MudIcon Icon="@Icons.Material.Filled.Source" Size="Size.Small"
                                 Style="vertical-align: middle;" Class="mr-1" />
                        Fuentes (@Message.References.Count):
                    </MudText>
                    <div class="d-flex flex-wrap gap-1">
                        @foreach (var reference in Message.References)
                        {
                            <MudChip T="string"
                                     Size="Size.Small"
                                     Color="Color.Primary"
                                     Variant="Variant.Outlined"
                                      OnClick="@(() => OnReferenceClick.InvokeAsync((reference.DocumentId, reference.ChunkIndex)))"
                                     Style="cursor: pointer;">
                                <MudIcon Icon="@Icons.Material.Filled.Description"
                                         Size="Size.Small" Class="mr-1" />
                                @TruncateFileName(reference.FileName, 20)
                                @if (reference.RelevanceScore > 0)
                                {
                                    <MudText Typo="Typo.caption" Class="ml-1"
                                             Style="opacity: 0.7;">
                                        (@((reference.RelevanceScore * 100).ToString("F0"))%)
                                    </MudText>
                                }
                            </MudChip>
                        }
                    </div>
                </div>
            }
        </MudPaper>

        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="@GetTimestampClass()">
            @Message.Timestamp.ToString("HH:mm")
        </MudText>
    </div>
}

@code {
    [Parameter]
    public ChatMessageDto? Message { get; set; }

    [Parameter]
    public EventCallback<(Guid DocumentId, int? ChunkIndex)> OnReferenceClick { get; set; }

    private string GetMessageContainerClass()
    {
        return Message?.IsUser == true
            ? "d-flex flex-column align-end"
            : "d-flex flex-column align-start";
    }

    private string GetMessageClass()
    {
        return Message?.IsUser == true
            ? "chat-message-user"
            : "chat-message-assistant";
    }

    private string GetMessageStyle()
    {
        var baseStyle = "max-width: 80%; border-radius: 12px;";

        if (Message?.IsUser == true)
        {
            return baseStyle + " background-color: var(--mud-palette-primary); color: var(--mud-palette-primary-text);";
        }

        return baseStyle;
    }

    private string GetTimestampClass()
    {
        return Message?.IsUser == true ? "mr-1 mt-1" : "ml-1 mt-1";
    }

    private static string TruncateFileName(string name, int maxLength)
    {
        if (string.IsNullOrEmpty(name)) return name;
        if (name.Length <= maxLength) return name;

        var extension = Path.GetExtension(name);
        var nameWithoutExt = Path.GetFileNameWithoutExtension(name);
        var maxNameLength = maxLength - extension.Length - 3;

        if (maxNameLength <= 0) return name[..maxLength];

        return nameWithoutExt[..maxNameLength] + "..." + extension;
    }
}
