@inject IHealthCheckService HealthCheckService

<MudMenu @ref="_menu"
         Icon="@GetOverallStatusIcon()"
         Color="@GetOverallStatusColor()"
         Dense="true"
         AnchorOrigin="Origin.BottomRight"
         TransformOrigin="Origin.TopRight">
    <ChildContent>
        <MudList T="string" Dense="true" Class="pa-0" Style="min-width: 280px;">
            <MudListSubheader Class="py-1">
                <div class="d-flex align-center justify-space-between" style="width: 100%;">
                    <MudText Typo="Typo.overline">Estado de Servicios</MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                   Size="Size.Small"
                                   OnClick="@RefreshStatusAsync"
                                   Disabled="@_isLoading" />
                </div>
            </MudListSubheader>

            @if (_isLoading)
            {
                <MudListItem T="string" Dense="true" Class="py-2">
                    <div class="d-flex justify-center">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        <MudText Typo="Typo.body2" Class="ml-2">Comprobando...</MudText>
                    </div>
                </MudListItem>
            }
            else if (_serviceStatuses.Count == 0)
            {
                <MudListItem T="string" Dense="true" Class="py-2">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Pulsa actualizar para comprobar
                    </MudText>
                </MudListItem>
            }
            else
            {
                @foreach (var status in _serviceStatuses)
                {
                    <MudListItem T="string" Dense="true" Class="py-1">
                        <div class="d-flex align-center justify-space-between" style="width: 100%;">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@GetStatusIcon(status.IsHealthy)"
                                         Color="@GetStatusColor(status.IsHealthy)"
                                         Size="Size.Small"
                                         Class="mr-2" />
                                <MudText Typo="Typo.body2">@status.ServiceName</MudText>
                            </div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @status.ResponseTime.TotalMilliseconds.ToString("0")ms
                            </MudText>
                        </div>
                    </MudListItem>
                }

                <MudDivider Class="my-1" />

                <MudListItem T="string" Dense="true" Class="py-1">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Ultima comprobacion: @_lastCheck?.ToString("HH:mm:ss")
                    </MudText>
                </MudListItem>
            }
        </MudList>
    </ChildContent>
</MudMenu>

@code {
    private MudMenu? _menu;
    private List<HealthCheckResult> _serviceStatuses = [];
    private DateTime? _lastCheck;
    private bool _isLoading;

    private async Task RefreshStatusAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(5));

            var sqlTask = HealthCheckService.CheckSqlServerAsync(cts.Token);
            var qdrantTask = HealthCheckService.CheckQdrantAsync(cts.Token);
            var ocrTask = HealthCheckService.CheckAzureOcrAsync(cts.Token);

            await Task.WhenAll(sqlTask, qdrantTask, ocrTask);

            _serviceStatuses =
            [
                await sqlTask,
                await qdrantTask,
                await ocrTask
            ];

            _lastCheck = DateTime.Now;
        }
        catch (OperationCanceledException)
        {
            _serviceStatuses =
            [
                new HealthCheckResult { ServiceName = "SQL Server", IsHealthy = false, Message = "Timeout" },
                new HealthCheckResult { ServiceName = "Qdrant", IsHealthy = false, Message = "Timeout" },
                new HealthCheckResult { ServiceName = "Azure OCR", IsHealthy = false, Message = "Timeout" }
            ];
            _lastCheck = DateTime.Now;
        }
        catch
        {
            _serviceStatuses =
            [
                new HealthCheckResult { ServiceName = "SQL Server", IsHealthy = false, Message = "No disponible" },
                new HealthCheckResult { ServiceName = "Qdrant", IsHealthy = false, Message = "No disponible" },
                new HealthCheckResult { ServiceName = "Azure OCR", IsHealthy = false, Message = "No disponible" }
            ];
            _lastCheck = DateTime.Now;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private string GetOverallStatusIcon()
    {
        if (_isLoading) return Icons.Material.Filled.Sync;
        if (_serviceStatuses.Count == 0) return Icons.Material.Filled.CloudQueue;

        var allHealthy = _serviceStatuses.All(s => s.IsHealthy);
        var anyHealthy = _serviceStatuses.Any(s => s.IsHealthy);

        return allHealthy ? Icons.Material.Filled.CheckCircle :
               anyHealthy ? Icons.Material.Filled.Warning :
               Icons.Material.Filled.Error;
    }

    private Color GetOverallStatusColor()
    {
        if (_isLoading || _serviceStatuses.Count == 0) return Color.Default;

        var allHealthy = _serviceStatuses.All(s => s.IsHealthy);
        var anyHealthy = _serviceStatuses.Any(s => s.IsHealthy);

        return allHealthy ? Color.Success :
               anyHealthy ? Color.Warning :
               Color.Error;
    }

    private static string GetStatusIcon(bool isHealthy) =>
        isHealthy ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel;

    private static Color GetStatusColor(bool isHealthy) =>
        isHealthy ? Color.Success : Color.Error;
}
