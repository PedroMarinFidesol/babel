@page "/project/{ProjectId:guid}"
@using Babel.Application.Projects.Queries
@using Babel.Application.Projects.Commands
@using Babel.Application.Documents.Queries
@using Babel.Application.Documents.Commands
@using Microsoft.AspNetCore.Components.Web
@inject IMediator Mediator
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>@(_project?.Name ?? "Proyecto") - Babel</PageTitle>

@if (_isLoading)
{
    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" Class="mb-4" />
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="500px" />
        </MudItem>
        <MudItem xs="12" md="6">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" Class="mb-4" />
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="280px" />
        </MudItem>
    </MudGrid>
}
else if (_errorMessage is not null)
{
    <MudAlert Severity="Severity.Error" Class="mb-4">
        @_errorMessage
        <MudButton Variant="Variant.Text" Color="Color.Inherit" OnClick="@LoadProject" Class="ml-4">
            Reintentar
        </MudButton>
    </MudAlert>
}
else if (_project is not null)
{
    @* Header con nombre del proyecto y acciones *@
    <div class="d-flex align-center mb-4">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                       OnClick="@GoBack"
                       Class="mr-2" />
        <MudText Typo="Typo.h4" Class="flex-grow-1">@_project.Name</MudText>
        <MudMenu Icon="@Icons.Material.Filled.MoreVert" AnchorOrigin="Origin.BottomRight">
            <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@ShowEditDialog">
                Editar proyecto
            </MudMenuItem>
            <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="@ShowDeleteDialog" Class="red-text">
                Eliminar proyecto
            </MudMenuItem>
        </MudMenu>
    </div>

    @if (!string.IsNullOrEmpty(_project.Description))
    {
        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
            @_project.Description
        </MudText>
    }

    @* Estadísticas del proyecto *@
    <MudGrid Class="mb-4">
        <MudItem xs="4">
            <MudPaper Elevation="2" Class="pa-4 text-center">
                <MudText Typo="Typo.h4" Color="Color.Primary">@_project.TotalDocuments</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Documentos</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="4">
            <MudPaper Elevation="2" Class="pa-4 text-center">
                <MudText Typo="Typo.h4" Color="Color.Success">@_project.ProcessedDocuments</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Procesados</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="4">
            <MudPaper Elevation="2" Class="pa-4 text-center">
                <MudText Typo="Typo.h4" Color="Color.Warning">@_project.PendingDocuments</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Pendientes</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    @* Contenido principal *@
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudText Typo="Typo.h6" Class="mb-2">Chat RAG</MudText>
            <ChatWindow ProjectId="@ProjectId" OnDocumentReferenceClick="@HandleDocumentClick" />
        </MudItem>

        <MudItem xs="12" md="6">
            <MudText Typo="Typo.h6" Class="mb-2">Subir Documentos</MudText>
            <FileUpload ProjectId="@ProjectId" OnFilesUploaded="@HandleFilesUploaded" />

            <MudText Typo="Typo.h6" Class="mb-2 mt-4">Documentos</MudText>
            <MudPaper Elevation="2" Class="pa-4">
                @if (_documents.Count == 0)
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center pa-4">
                        No hay documentos en este proyecto. Sube archivos para comenzar.
                    </MudText>
                }
                else
                {
                    <MudTable Items="@_documents" Dense="true" Hover="true" Elevation="0"
                              RowStyleFunc="@((doc, _) => GetRowStyle(doc))">
                        <HeaderContent>
                            <MudTh>Nombre</MudTh>
                            <MudTh>Tamaño</MudTh>
                            <MudTh>Estado</MudTh>
                            <MudTh Style="width: 50px;"></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Nombre">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@GetFileIcon(context.FileExtension)" Size="Size.Small" Class="mr-2" />
                                    @context.FileName
                                </div>
                            </MudTd>
                            <MudTd DataLabel="Tamaño">@context.FileSizeFormatted</MudTd>
                            <MudTd DataLabel="Estado">
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)" Variant="Variant.Filled">
                                    @GetStatusText(context.Status)
                                </MudChip>
                            </MudTd>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               OnClick="@(() => DeleteDocument(context))"
                                               Disabled="@(_deletingDocumentId == context.Id)" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@* Edit Project Dialog *@
<MudDialog @bind-Visible="_showEditDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2" />
            Editar Proyecto
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_editProjectName"
                      Label="Nombre del proyecto"
                      Variant="Variant.Outlined"
                      Required="true"
                      Class="mb-4" />
        <MudTextField @bind-Value="_editProjectDescription"
                      Label="Descripción (opcional)"
                      Variant="Variant.Outlined"
                      Lines="3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showEditDialog = false)">Cancelar</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="@UpdateProject"
                   Disabled="@(string.IsNullOrWhiteSpace(_editProjectName) || _isUpdating)">
            @if (_isUpdating)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Guardar
        </MudButton>
    </DialogActions>
</MudDialog>

@* Document Detail Dialog *@
<MudDialog @bind-Visible="_showDocumentDialog" Options="@(new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraLarge })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Description" Class="mr-2" />
            @_selectedDocument?.FileName
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_isLoadingDocumentContent)
        {
            <div class="d-flex flex-column align-center pa-8">
                <MudProgressCircular Size="Size.Large" Indeterminate="true" Class="mb-4" />
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    Cargando contenido...
                </MudText>
            </div>
        }
        else if (_documentContentError is not null)
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">
                @_documentContentError
            </MudAlert>
        }
        else
        {
            <MudPaper Elevation="1" Class="pa-4 mb-4" Style="max-height: 400px; overflow-y: auto;">
                <MudText Typo="Typo.body2" Style="white-space: pre-wrap; line-height: 1.6;">
                    @(_documentContent ?? "Sin contenido disponible")
                </MudText>
            </MudPaper>

            @if (_selectedDocument is not null)
            {
                <MudGrid Class="mt-4">
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Tamaño:</MudText>
                        <MudText Typo="Typo.body2">@_selectedDocument.FileSizeFormatted</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Tipo:</MudText>
                        <MudText Typo="Typo.body2">@_selectedDocument.MimeType</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Estado:</MudText>
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_selectedDocument.Status)" Variant="Variant.Filled">
                            @GetStatusText(_selectedDocument.Status)
                        </MudChip>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Procesado:</MudText>
                        <MudText Typo="Typo.body2">@(_selectedDocument.ProcessedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</MudText>
                    </MudItem>
                    @if (_selectedDocument.IsVectorized)
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.caption" Color="Color.Primary">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                                Este documento ha sido vectorizado y está disponible para búsquedas semánticas
                            </MudText>
                        </MudItem>
                    }
                </MudGrid>
            }
        }
    </DialogContent>
    <DialogActions>
        @if (_selectedDocument is not null && !_isLoadingDocumentContent)
        {
            <MudButton OnClick="@(() => _showDocumentDialog = false)">
                Cerrar
            </MudButton>
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       StartIcon="@Icons.Material.Filled.Download"
                       OnClick="@DownloadDocument"
                       Disabled="@(!_selectedDocument.IsVectorized && _selectedDocument.Status != Domain.Enums.DocumentStatus.Completed)">
                Descargar
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@* Delete Confirmation Dialog *@
<MudDialog @bind-Visible="_showDeleteDialog">
    <TitleContent>
        <MudText Typo="Typo.h6" Color="Color.Error">
            <MudIcon Icon="@Icons.Material.Filled.Warning" Class="mr-2" />
            Eliminar Proyecto
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudText>
            ¿Estás seguro de que deseas eliminar el proyecto <strong>@_project?.Name</strong>?
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
            Esta acción eliminará todos los documentos asociados y no se puede deshacer.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showDeleteDialog = false)">Cancelar</MudButton>
        <MudButton Color="Color.Error"
                   Variant="Variant.Filled"
                   OnClick="@DeleteProject"
                   Disabled="@_isDeleting">
            @if (_isDeleting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Eliminar
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public Guid ProjectId { get; set; }

    private ProjectDto? _project;
    private List<DocumentDto> _documents = [];

    private bool _isLoading = true;
    private string? _errorMessage;

    // Edit dialog state
    private bool _showEditDialog;
    private bool _isUpdating;
    private string _editProjectName = "";
    private string _editProjectDescription = "";

    // Delete dialog state
    private bool _showDeleteDialog;
    private bool _isDeleting;

    // Document delete state
    private Guid? _deletingDocumentId;

    // Document highlight state (from chat reference click)
    private Guid? _highlightedDocumentId;

    // Document dialog state
    private bool _showDocumentDialog;
    private DocumentDto? _selectedDocument;
    private string? _documentContent;
    private bool _isLoadingDocumentContent;
    private string? _documentContentError;

    protected override async Task OnInitializedAsync()
    {
        await LoadProjectAndDocuments();
    }

    private async Task LoadProjectAndDocuments()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var projectResult = await Mediator.Send(new GetProjectByIdQuery(ProjectId));

            if (projectResult.IsSuccess)
            {
                _project = projectResult.Value!;

                var documentsResult = await Mediator.Send(new GetDocumentsByProjectQuery(ProjectId));
                if (documentsResult.IsSuccess)
                {
                    _documents = documentsResult.Value!.ToList();
                }
            }
            else
            {
                _errorMessage = projectResult.Error.Description;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al cargar el proyecto: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadProject()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var result = await Mediator.Send(new GetProjectByIdQuery(ProjectId));

            if (result.IsSuccess)
            {
                _project = result.Value!;
            }
            else
            {
                _errorMessage = result.Error.Description;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al cargar el proyecto: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadDocuments()
    {
        try
        {
            var result = await Mediator.Send(new GetDocumentsByProjectQuery(ProjectId));
            if (result.IsSuccess)
            {
                _documents = result.Value!.ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar documentos: {ex.Message}", Severity.Error);
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private void ShowEditDialog()
    {
        if (_project is null) return;

        _editProjectName = _project.Name;
        _editProjectDescription = _project.Description ?? "";
        _showEditDialog = true;
    }

    private async Task UpdateProject()
    {
        if (_project is null) return;

        _isUpdating = true;

        try
        {
            var command = new UpdateProjectCommand(ProjectId, _editProjectName, _editProjectDescription);
            var result = await Mediator.Send(command);

            if (result.IsSuccess)
            {
                _project = result.Value!;
                Snackbar.Add("Proyecto actualizado exitosamente", Severity.Success);
                _showEditDialog = false;
            }
            else
            {
                Snackbar.Add(result.Error.Description, Severity.Error);
            }
        }
        catch (FluentValidation.ValidationException ex)
        {
            var errors = string.Join(", ", ex.Errors.Select(e => e.ErrorMessage));
            Snackbar.Add(errors, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al actualizar: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUpdating = false;
        }
    }

    private void ShowDeleteDialog()
    {
        _showDeleteDialog = true;
    }

    private async Task DeleteProject()
    {
        _isDeleting = true;

        try
        {
            var result = await Mediator.Send(new DeleteProjectCommand(ProjectId));

            if (result.IsSuccess)
            {
                Snackbar.Add($"Proyecto '{_project?.Name}' eliminado", Severity.Success);
                Navigation.NavigateTo("/");
            }
            else
            {
                Snackbar.Add(result.Error.Description, Severity.Error);
                _showDeleteDialog = false;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al eliminar: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isDeleting = false;
        }
    }

    private async Task HandleDocumentClick(Guid documentId)
    {
        var document = _documents.FirstOrDefault(d => d.Id == documentId);
        if (document == null)
        {
            Snackbar.Add("Documento no encontrado", Severity.Warning);
            return;
        }

        // Resaltar en la tabla
        _highlightedDocumentId = documentId;
        StateHasChanged();

        // Quitar highlight después de 3 segundos
        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            _highlightedDocumentId = null;
            InvokeAsync(StateHasChanged);
        });

        // Abrir diálogo con información del documento
        _selectedDocument = document;
        _documentContent = null;
        _documentContentError = null;
        _isLoadingDocumentContent = true;
        _showDocumentDialog = true;

        // Cargar contenido del documento
        try
        {
            var result = await Mediator.Send(new GetDocumentTextQuery(documentId));
            if (result.IsSuccess)
            {
                _documentContent = result.Value ?? "Sin contenido disponible (el documento aún no ha sido procesado)";
            }
            else
            {
                _documentContentError = result.Error.Description;
            }
        }
        catch (Exception ex)
        {
            _documentContentError = $"Error al cargar: {ex.Message}";
        }
        finally
        {
            _isLoadingDocumentContent = false;
            StateHasChanged();
        }
    }

    private async Task HandleFilesUploaded(List<DocumentDto> documents)
    {
        foreach (var doc in documents)
        {
            _documents.Insert(0, doc);
        }

        if (_project is not null)
        {
            _project.TotalDocuments += documents.Count;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task DeleteDocument(DocumentDto document)
    {
        _deletingDocumentId = document.Id;

        try
        {
            var result = await Mediator.Send(new DeleteDocumentCommand(document.Id));

            if (result.IsSuccess)
            {
                _documents.Remove(document);

                if (_project is not null)
                {
                    _project.TotalDocuments = Math.Max(0, _project.TotalDocuments - 1);
                }

                Snackbar.Add($"Documento '{document.FileName}' eliminado", Severity.Success);
            }
            else
            {
                Snackbar.Add(result.Error.Description, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al eliminar: {ex.Message}", Severity.Error);
        }
        finally
        {
            _deletingDocumentId = null;
        }
    }

    private static string GetFileIcon(string extension) => extension.ToLower() switch
    {
        ".pdf" => Icons.Material.Filled.PictureAsPdf,
        ".png" or ".jpg" or ".jpeg" => Icons.Material.Filled.Image,
        ".docx" or ".doc" => Icons.Material.Filled.Article,
        ".xlsx" or ".xls" => Icons.Material.Filled.TableChart,
        ".txt" or ".md" => Icons.Material.Filled.TextSnippet,
        _ => Icons.Material.Filled.InsertDriveFile
    };

    private static Color GetStatusColor(Babel.Domain.Enums.DocumentStatus status) => status switch
    {
        Babel.Domain.Enums.DocumentStatus.Completed => Color.Success,
        Babel.Domain.Enums.DocumentStatus.Processing => Color.Info,
        Babel.Domain.Enums.DocumentStatus.Pending => Color.Warning,
        Babel.Domain.Enums.DocumentStatus.Failed => Color.Error,
        Babel.Domain.Enums.DocumentStatus.PendingReview => Color.Secondary,
        _ => Color.Default
    };

    private static string GetStatusText(Babel.Domain.Enums.DocumentStatus status) => status switch
    {
        Babel.Domain.Enums.DocumentStatus.Completed => "Completado",
        Babel.Domain.Enums.DocumentStatus.Processing => "Procesando",
        Babel.Domain.Enums.DocumentStatus.Pending => "Pendiente",
        Babel.Domain.Enums.DocumentStatus.Failed => "Error",
        Babel.Domain.Enums.DocumentStatus.PendingReview => "Revisión",
        _ => "Desconocido"
    };

    private string GetRowStyle(DocumentDto document)
    {
        if (_highlightedDocumentId == document.Id)
        {
            return "background-color: var(--mud-palette-primary-lighten); transition: background-color 0.3s ease;";
        }
        return "";
    }

    private void DownloadDocument()
    {
        if (_selectedDocument is null) return;

        Navigation.NavigateTo($"/api/documents/{_selectedDocument.Id}/download", forceLoad: true);
    }
}
