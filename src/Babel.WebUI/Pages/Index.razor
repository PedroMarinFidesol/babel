@page "/"
@using Babel.Application.Projects.Queries
@using Babel.Application.Projects.Commands
@inject IMediator Mediator
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Babel - Inicio</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Proyectos</MudText>

@if (_isLoading)
{
    <MudGrid>
        @for (int i = 0; i < 4; i++)
        {
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="180px" />
            </MudItem>
        }
    </MudGrid>
}
else if (_errorMessage is not null)
{
    <MudAlert Severity="Severity.Error" Class="mb-4">
        @_errorMessage
        <MudButton Variant="Variant.Text" Color="Color.Inherit" OnClick="@LoadProjects" Class="ml-4">
            Reintentar
        </MudButton>
    </MudAlert>
}
else
{
    <MudGrid>
        @foreach (var project in _projects)
        {
            <MudItem xs="12" sm="6" md="4" lg="3">
                <ProjectCard Project="@project"
                             OnCardClick="@NavigateToProject"
                             OnEdit="@ShowEditProjectDialog"
                             OnDelete="@ShowDeleteProjectDialog" />
            </MudItem>
        }

        <MudItem xs="12" sm="6" md="4" lg="3">
            <ProjectCard IsCreateNew="true" OnCreate="@ShowCreateProjectDialog" />
        </MudItem>
    </MudGrid>
}

@* Create Project Dialog *@
<MudDialog @bind-Visible="_showCreateDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.CreateNewFolder" Class="mr-2" />
            Nuevo Proyecto
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_newProjectName"
                      Label="Nombre del proyecto"
                      Variant="Variant.Outlined"
                      Required="true"
                      Class="mb-4" />
        <MudTextField @bind-Value="_newProjectDescription"
                      Label="Descripcion (opcional)"
                      Variant="Variant.Outlined"
                      Lines="3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showCreateDialog = false)">Cancelar</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="@CreateProject"
                   Disabled="@(string.IsNullOrWhiteSpace(_newProjectName) || _isCreating)">
            @if (_isCreating)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Crear
        </MudButton>
    </DialogActions>
</MudDialog>

@* Edit Project Dialog *@
<MudDialog @bind-Visible="_showEditDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2" />
            Editar Proyecto
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_editProjectName"
                      Label="Nombre del proyecto"
                      Variant="Variant.Outlined"
                      Required="true"
                      Class="mb-4" />
        <MudTextField @bind-Value="_editProjectDescription"
                      Label="Descripcion (opcional)"
                      Variant="Variant.Outlined"
                      Lines="3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showEditDialog = false)">Cancelar</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="@UpdateProject"
                   Disabled="@(string.IsNullOrWhiteSpace(_editProjectName) || _isUpdating)">
            @if (_isUpdating)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Guardar
        </MudButton>
    </DialogActions>
</MudDialog>

@* Delete Confirmation Dialog *@
<MudDialog @bind-Visible="_showDeleteDialog">
    <TitleContent>
        <MudText Typo="Typo.h6" Color="Color.Error">
            <MudIcon Icon="@Icons.Material.Filled.Warning" Class="mr-2" />
            Eliminar Proyecto
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudText>
            ¿Estás seguro de que deseas eliminar el proyecto <strong>@_selectedProject?.Name</strong>?
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
            Esta acción eliminará todos los documentos asociados y no se puede deshacer.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showDeleteDialog = false)">Cancelar</MudButton>
        <MudButton Color="Color.Error"
                   Variant="Variant.Filled"
                   OnClick="@DeleteProject"
                   Disabled="@_isDeleting">
            @if (_isDeleting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Eliminar
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<ProjectDto> _projects = [];
    private ProjectDto? _selectedProject;

    private bool _isLoading = true;
    private string? _errorMessage;

    // Create dialog state
    private bool _showCreateDialog;
    private bool _isCreating;
    private string _newProjectName = "";
    private string _newProjectDescription = "";

    // Edit dialog state
    private bool _showEditDialog;
    private bool _isUpdating;
    private string _editProjectName = "";
    private string _editProjectDescription = "";

    // Delete dialog state
    private bool _showDeleteDialog;
    private bool _isDeleting;

    protected override async Task OnInitializedAsync()
    {
        await LoadProjects();
    }

    private async Task LoadProjects()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var result = await Mediator.Send(new GetProjectsQuery());

            if (result.IsSuccess)
            {
                _projects = result.Value!;
            }
            else
            {
                _errorMessage = result.Error.Description;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al cargar proyectos: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void NavigateToProject(ProjectDto project)
    {
        Navigation.NavigateTo($"/project/{project.Id}");
    }

    #region Create Project

    private void ShowCreateProjectDialog()
    {
        _newProjectName = "";
        _newProjectDescription = "";
        _showCreateDialog = true;
    }

    private async Task CreateProject()
    {
        _isCreating = true;

        try
        {
            var command = new CreateProjectCommand(_newProjectName, _newProjectDescription);
            var result = await Mediator.Send(command);

            if (result.IsSuccess)
            {
                Snackbar.Add($"Proyecto '{result.Value!.Name}' creado exitosamente", Severity.Success);
                _showCreateDialog = false;
                await LoadProjects();
            }
            else
            {
                Snackbar.Add(result.Error.Description, Severity.Error);
            }
        }
        catch (FluentValidation.ValidationException ex)
        {
            var errors = string.Join(", ", ex.Errors.Select(e => e.ErrorMessage));
            Snackbar.Add(errors, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al crear proyecto: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isCreating = false;
        }
    }

    #endregion

    #region Edit Project

    private void ShowEditProjectDialog(ProjectDto project)
    {
        _selectedProject = project;
        _editProjectName = project.Name;
        _editProjectDescription = project.Description ?? "";
        _showEditDialog = true;
    }

    private async Task UpdateProject()
    {
        if (_selectedProject is null) return;

        _isUpdating = true;

        try
        {
            var command = new UpdateProjectCommand(_selectedProject.Id, _editProjectName, _editProjectDescription);
            var result = await Mediator.Send(command);

            if (result.IsSuccess)
            {
                Snackbar.Add("Proyecto actualizado exitosamente", Severity.Success);
                _showEditDialog = false;
                await LoadProjects();
            }
            else
            {
                Snackbar.Add(result.Error.Description, Severity.Error);
            }
        }
        catch (FluentValidation.ValidationException ex)
        {
            var errors = string.Join(", ", ex.Errors.Select(e => e.ErrorMessage));
            Snackbar.Add(errors, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al actualizar: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUpdating = false;
        }
    }

    #endregion

    #region Delete Project

    private void ShowDeleteProjectDialog(ProjectDto project)
    {
        _selectedProject = project;
        _showDeleteDialog = true;
    }

    private async Task DeleteProject()
    {
        if (_selectedProject is null) return;

        _isDeleting = true;

        try
        {
            var result = await Mediator.Send(new DeleteProjectCommand(_selectedProject.Id));

            if (result.IsSuccess)
            {
                Snackbar.Add($"Proyecto '{_selectedProject.Name}' eliminado", Severity.Success);
                _showDeleteDialog = false;
                await LoadProjects();
            }
            else
            {
                Snackbar.Add(result.Error.Description, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al eliminar: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isDeleting = false;
        }
    }

    #endregion
}
